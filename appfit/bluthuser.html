<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smartwatch Sync Universale - Versione Migliorata</title>

  <style>
    :root {
      /* Light Theme */
      --primary-color: #6366f1;
      --primary-hover: #5b21b6;
      --secondary-color: #8b5cf6;
      --success-color: #10b981;
      --error-color: #ef4444;
      --warning-color: #f59e0b;
      --info-color: #3b82f6;
      
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --bg-tertiary: #f1f5f9;
      --bg-card: #ffffff;
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --text-inverse: #ffffff;
      
      --border-color: #e2e8f0;
      --border-hover: #cbd5e1;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      
      --border-radius-sm: 6px;
      --border-radius: 12px;
      --border-radius-lg: 16px;
      --border-radius-xl: 24px;
      
      --transition-fast: all 0.15s ease;
      --transition: all 0.3s ease;
      --transition-slow: all 0.5s ease;
    }

    [data-theme="dark"] {
      /* Dark Theme */
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --bg-card: #1e293b;
      --bg-gradient: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --text-muted: #94a3b8;
      --text-inverse: #0f172a;
      
      --border-color: #334155;
      --border-hover: #475569;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.4);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
      background: var(--bg-gradient);
      min-height: 100vh;
      color: var(--text-primary);
      transition: var(--transition);
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: var(--bg-primary);
      border-radius: var(--border-radius-xl);
      box-shadow: var(--shadow-xl);
      overflow: hidden;
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-color);
      transition: var(--transition);
    }

    .header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: var(--text-inverse);
      padding: 3rem 2rem;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
      opacity: 0.3;
    }

    .header-content {
      position: relative;
      z-index: 1;
    }

    .header h1 {
      font-size: 3rem;
      font-weight: 800;
      margin-bottom: 0.5rem;
      background: linear-gradient(45deg, #ffffff, #e0e7ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header p {
      font-size: 1.2rem;
      opacity: 0.9;
      font-weight: 300;
    }

    .theme-toggle {
      position: absolute;
      top: 2rem;
      right: 2rem;
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: var(--border-radius);
      padding: 0.75rem;
      cursor: pointer;
      transition: var(--transition);
      backdrop-filter: blur(10px);
      color: var(--text-inverse);
      font-size: 1.2rem;
      z-index: 2;
    }

    .theme-toggle:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    .content {
      padding: 3rem 2rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 2rem;
    }

    @media (max-width: 768px) {
      .content {
        grid-template-columns: 1fr;
        gap: 1.5rem;
        padding: 2rem 1rem;
      }
      
      .header {
        padding: 2rem 1rem;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .theme-toggle {
        top: 1rem;
        right: 1rem;
      }
    }

    .section {
      background: var(--bg-card);
      border-radius: var(--border-radius-lg);
      padding: 2rem;
      border: 1px solid var(--border-color);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      opacity: 0;
      transition: var(--transition);
    }

    .section:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
      border-color: var(--border-hover);
    }

    .section:hover::before {
      opacity: 1;
    }

    .section h2 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .section h2::before {
      content: '';
      width: 8px;
      height: 8px;
      background: var(--primary-color);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }

    .btn {
      padding: 1rem 1.5rem;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      margin: 0.5rem 0.5rem 0.5rem 0;
      text-decoration: none;
      min-height: 48px;
      position: relative;
      overflow: hidden;
      font-family: inherit;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: var(--transition);
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
      color: var(--text-inverse);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success-color), #059669);
      color: var(--text-inverse);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--error-color), #dc2626);
      color: var(--text-inverse);
    }

    .btn-secondary {
      background: linear-gradient(135deg, var(--text-secondary), var(--text-muted));
      color: var(--text-inverse);
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary-color);
      color: var(--primary-color);
    }

    .btn-outline:hover {
      background: var(--primary-color);
      color: var(--text-inverse);
    }

    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .device-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      margin-bottom: 1rem;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .device-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: var(--success-color);
      transform: scaleY(0);
      transition: var(--transition);
    }

    .device-item:hover {
      border-color: var(--primary-color);
      box-shadow: var(--shadow-md);
      transform: translateX(4px);
    }

    .device-item:hover::before {
      transform: scaleY(1);
    }

    .device-info {
      flex: 1;
    }

    .device-name {
      font-weight: 700;
      color: var(--text-primary);
      font-size: 1.1rem;
      margin-bottom: 0.25rem;
    }

    .device-id {
      font-size: 0.875rem;
      color: var(--text-muted);
      font-family: 'JetBrains Mono', 'Courier New', monospace;
      background: var(--bg-tertiary);
      padding: 0.25rem 0.5rem;
      border-radius: var(--border-radius-sm);
      display: inline-block;
    }

    .device-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      grid-column: 1 / -1;
      margin-top: 2rem;
    }

    .stat-card {
      background: var(--bg-card);
      padding: 2rem;
      border-radius: var(--border-radius-lg);
      text-align: center;
      border: 1px solid var(--border-color);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, var(--primary-color)10, var(--secondary-color)10);
      opacity: 0;
      transition: var(--transition);
    }

    .stat-card:hover {
      border-color: var(--primary-color);
      box-shadow: var(--shadow-lg);
      transform: translateY(-8px);
    }

    .stat-card:hover::before {
      opacity: 1;
    }

    .stat-card > * {
      position: relative;
      z-index: 1;
    }

    .stat-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      display: block;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--primary-color);
      margin: 1rem 0;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 1rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-note {
      color: var(--text-muted);
      font-size: 0.875rem;
      margin-top: 0.5rem;
      font-style: italic;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 2rem;
      color: var(--text-muted);
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
      animation: bounce 2s infinite;
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      60% { transform: translateY(-5px); }
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 0.75rem;
      position: relative;
    }

    .status-indicator::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      border-radius: 50%;
      animation: ripple 2s infinite;
    }

    .status-connected {
      background: var(--success-color);
    }

    .status-connected::before {
      background: var(--success-color);
      opacity: 0.3;
    }

    .status-disconnected {
      background: var(--text-muted);
    }

    @keyframes ripple {
      0% { transform: scale(1); opacity: 0.3; }
      100% { transform: scale(2); opacity: 0; }
    }

    .toast {
      position: fixed;
      top: 2rem;
      right: 2rem;
      padding: 1rem 1.5rem;
      border-radius: var(--border-radius);
      color: var(--text-inverse);
      font-weight: 600;
      z-index: 1000;
      transform: translateX(100%);
      transition: var(--transition);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      max-width: 400px;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast-success {
      background: linear-gradient(135deg, var(--success-color), #059669);
    }

    .toast-error {
      background: linear-gradient(135deg, var(--error-color), #dc2626);
    }

    .toast-warning {
      background: linear-gradient(135deg, var(--warning-color), #d97706);
    }

    .toast-info {
      background: linear-gradient(135deg, var(--info-color), #2563eb);
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: var(--text-inverse);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .btn-loading {
      pointer-events: none;
      opacity: 0.7;
    }

    .compatibility-warning {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      border: 1px solid var(--warning-color);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      margin-bottom: 2rem;
      color: #92400e;
      position: relative;
      overflow: hidden;
    }

    .compatibility-warning::before {
      content: '‚ö†Ô∏è';
      position: absolute;
      top: 1rem;
      right: 1rem;
      font-size: 1.5rem;
      opacity: 0.3;
    }

    .compatibility-warning h3 {
      margin: 0 0 1rem 0;
      font-size: 1.1rem;
      font-weight: 700;
    }

    .compatibility-warning ul {
      margin: 0.5rem 0 0 1.5rem;
      font-size: 0.9rem;
      line-height: 1.6;
    }

    .compatibility-warning li {
      margin-bottom: 0.5rem;
    }

    /* Scrollbar personalizzata */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-secondary);
      border-radius: var(--border-radius-sm);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--text-muted);
      border-radius: var(--border-radius-sm);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }

    /* Animazioni di entrata */
    .fade-in {
      animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .slide-in {
      animation: slideIn 0.8s ease-out;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-30px); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* Focus states per accessibilit√† */
    .btn:focus,
    .theme-toggle:focus {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
    }

    /* Responsive migliorato */
    @media (max-width: 480px) {
      .controls-grid {
        grid-template-columns: 1fr;
      }
      
      .device-actions {
        flex-direction: column;
        width: 100%;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container fade-in">
    <div class="header">
      <button class="theme-toggle" onclick="toggleTheme()" title="Cambia tema">
        <span id="theme-icon">üåô</span>
      </button>
      <div class="header-content">
        <h1>üîó Smartwatch Sync Universale</h1>
        <p>Connetti e monitora i tuoi dispositivi wearable con stile</p>
      </div>
    </div>

    <div class="content">
      <div class="section slide-in">
        <h2>‚öôÔ∏è Controlli</h2>
        
        <div class="compatibility-warning">
          <h3>Limitazioni note:</h3>
          <ul>
            <li><strong>Apple Watch:</strong> Non supporta Web Bluetooth</li>
            <li><strong>Smartphone:</strong> Non condividono dati fitness via BLE</li>
            <li><strong>Alcuni smartwatch:</strong> Usano protocolli proprietari</li>
            <li><strong>Richiesto HTTPS:</strong> Chrome/Edge su connessione sicura</li>
          </ul>
        </div>

        <div class="controls-grid">
          <button class="btn btn-primary" onclick="checkCompatibility()">
            ‚úÖ Verifica compatibilit√†
          </button>
          <button class="btn btn-success" onclick="scanNewDevice()">
            üîç Scansiona dispositivi
          </button>
          <button class="btn btn-outline" onclick="testConnection()">
            üß™ Test connessione
          </button>
        </div>
      </div>

      <div class="section slide-in">
        <h2>üíæ Dispositivi Salvati</h2>
        <div id="savedDevices">
          <div class="empty-state">
            <div class="empty-state-icon">üì±</div>
            <p>Nessun dispositivo salvato</p>
            <small>Scansiona per trovare dispositivi compatibili</small>
          </div>
        </div>
      </div>

      <div class="section slide-in">
        <h2>üìä Statistiche Fitness</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">üíì</div>
            <div class="stat-value" id="heartRate">--</div>
            <div class="stat-label">Battiti per minuto</div>
            <div class="stat-note">Richiede smartwatch con sensore HR</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon">üëü</div>
            <div class="stat-value" id="stepCount">--</div>
            <div class="stat-label">Passi giornalieri</div>
            <div class="stat-note">Solo da smartwatch/fitness tracker</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    class ImprovedSmartWatch {
      constructor() {
        this.heartEl = document.getElementById("heartRate");
        this.stepEl = document.getElementById("stepCount");
        this.connectedDevices = new Map();
        this.reconnectInterval = null;
        
        // Servizi BLE estesi con pi√π brand
        this.EXTENDED_SERVICES = [
          // Standard fitness services
          "heart_rate", 
          "battery_service", 
          "device_information", 
          "fitness_machine",
          0x1826, // Fitness Machine Service
          0x1814, // Running Speed and Cadence
          0x1816, // Cycling Speed and Cadence
          0x181C, // User Data
          0x181D, // Weight Scale
          0x180D, // Heart Rate Service
          0x180F, // Battery Service
          0x180A, // Device Information Service
          
          // Xiaomi Mi Band services (pi√π comuni)
          "0000fee0-0000-1000-8000-00805f9b34fb", // Mi Band Main Service
          "0000fee1-0000-1000-8000-00805f9b34fb", // Mi Band Service 2
          "6e400001-b5a3-f393-e0a9-e50e24dcca9e", // Nordic UART Service (usato da molti)
          
          // Garmin services
          "0000fec8-0000-1000-8000-00805f9b34fb",
          "0000fec9-0000-1000-8000-00805f9b34fb",
          
          // Samsung Galaxy Watch
          "00001801-0000-1000-8000-00805f9b34fb",
          "00001800-0000-1000-8000-00805f9b34fb",
          
          // Polar services
          "6217ff4b-fb31-1140-ad5a-a45545d7ecf3",
          "6217ff4c-c8ec-b1fb-1380-3ad986708e2d",
          
          // Suunto services
          "6e400001-b5a3-f393-e0a9-e50e24dcca9e"
        ];
        
        this.init();
      }

      init() {
        this.setupEventListeners();
        this.loadSavedDevices();
        this.showToast("üöÄ Applicazione inizializzata con successo!", "success");
      }

      setupEventListeners() {
        // Gestione visibilit√† pagina per ottimizzare performance
        document.addEventListener('visibilitychange', () => {
          if (document.hidden) {
            // Pagina nascosta - riduci aggiornamenti
          } else {
            // Pagina visibile - riprendi aggiornamenti normali
          }
        });

        // Gestione errori globali
        window.addEventListener('error', (e) => {
          console.error(`Errore JavaScript: ${e.message} in ${e.filename}:${e.lineno}`);
        });

        window.addEventListener('unhandledrejection', (e) => {
          console.error(`Promise rifiutata: ${e.reason}`);
        });
      }

      showToast(message, type = "success") {
        const toast = document.createElement("div");
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => toast.classList.add("show"), 100);
        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => {
            if (document.body.contains(toast)) {
              document.body.removeChild(toast);
            }
          }, 300);
        }, 4000);
      }

      setButtonLoading(button, loading) {
        if (loading) {
          button.classList.add("btn-loading");
          const originalText = button.innerHTML;
          button.dataset.originalText = originalText;
          button.innerHTML = `<span class="loading"></span> Caricamento...`;
        } else {
          button.classList.remove("btn-loading");
          if (button.dataset.originalText) {
            button.innerHTML = button.dataset.originalText;
          }
        }
      }

      checkCompatibility() {
        if (!navigator.bluetooth) {
          this.showToast("‚ùå Web Bluetooth non supportato. Usa Chrome o Edge su HTTPS.", "error");
          return false;
        }
        
        // Verifica disponibilit√† API avanzate
        const hasGetDevices = navigator.bluetooth.getDevices !== undefined;
        const hasGetAvailability = navigator.bluetooth.getAvailability !== undefined;
        
        this.showToast("‚úÖ Web Bluetooth supportato!", "success");
        
        // Verifica disponibilit√† Bluetooth
        if (hasGetAvailability) {
          navigator.bluetooth.getAvailability().then(available => {
            if (available) {
              this.showToast("üì° Bluetooth disponibile e attivo", "success");
            } else {
              this.showToast("‚ö†Ô∏è Bluetooth non disponibile o disattivato", "warning");
            }
          }).catch(err => {
            this.showToast("‚ùå Errore verifica Bluetooth: " + err.message, "error");
          });
        }
        
        return true;
      }

      async scanNewDevice() {
        if (!this.checkCompatibility()) return;

        const scanButton = event.target;
        this.setButtonLoading(scanButton, true);

        try {
          const device = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: this.EXTENDED_SERVICES
          });

          if (device) {
            await this.connectToDevice(device);
            this.saveDevice(device);
            this.showToast(`‚úÖ Dispositivo ${device.name || 'Sconosciuto'} trovato!`, "success");
          }
        } catch (error) {
          if (error.name === 'NotFoundError') {
            this.showToast("‚ùå Nessun dispositivo selezionato", "warning");
          } else if (error.name === 'SecurityError') {
            this.showToast("üîí Errore di sicurezza - richiesto HTTPS", "error");
          } else {
            this.showToast(`‚ùå Errore scansione: ${error.message}`, "error");
          }
        } finally {
          this.setButtonLoading(scanButton, false);
        }
      }

      async connectToDevice(device) {
        try {
          const server = await device.gatt.connect();
          
          const deviceInfo = {
            id: device.id,
            name: device.name || 'Dispositivo Sconosciuto',
            server: server,
            lastSeen: new Date().toISOString()
          };
          
          this.connectedDevices.set(device.id, deviceInfo);
          
          // Gestione disconnessione
          device.addEventListener('gattserverdisconnected', () => {
            this.connectedDevices.delete(device.id);
            this.updateDevicesList();
            this.showToast(`üì± ${deviceInfo.name} disconnesso`, "info");
          });
          
          // Prova a leggere servizi disponibili
          await this.discoverServices(server, deviceInfo);
          
          this.updateDevicesList();
          
        } catch (error) {
          this.showToast(`‚ùå Errore connessione: ${error.message}`, "error");
        }
      }

      async discoverServices(server, deviceInfo) {
        try {
          const services = await server.getPrimaryServices();
          deviceInfo.services = [];
          
          for (const service of services) {
            const serviceInfo = {
              uuid: service.uuid,
              characteristics: []
            };
            
            try {
              const characteristics = await service.getCharacteristics();
              for (const char of characteristics) {
                serviceInfo.characteristics.push({
                  uuid: char.uuid,
                  properties: char.properties
                });
                
                // Prova a leggere dati dal sensore di battito cardiaco
                if (char.uuid === "00002a37-0000-1000-8000-00805f9b34fb") {
                  await this.setupHeartRateMonitoring(char);
                }
              }
            } catch (charError) {
              console.warn(`Impossibile leggere caratteristiche per ${service.uuid}:`, charError);
            }
            
            deviceInfo.services.push(serviceInfo);
          }
          
        } catch (error) {
          console.warn("Errore discovery servizi:", error);
        }
      }

      async setupHeartRateMonitoring(characteristic) {
        try {
          await characteristic.startNotifications();
          characteristic.addEventListener('characteristicvaluechanged', (event) => {
            const value = event.target.value;
            const heartRate = value.getUint16(1, true);
            this.heartEl.textContent = heartRate;
            this.showToast(`üíì Battito cardiaco: ${heartRate} BPM`, "info");
          });
        } catch (error) {
          console.warn("Errore setup monitoraggio battito:", error);
        }
      }

      saveDevice(device) {
        const savedDevices = JSON.parse(localStorage.getItem('smartwatchDevices') || '[]');
        const deviceData = {
          id: device.id,
          name: device.name || 'Dispositivo Sconosciuto',
          lastConnected: new Date().toISOString()
        };
        
        // Evita duplicati
        const existingIndex = savedDevices.findIndex(d => d.id === device.id);
        if (existingIndex >= 0) {
          savedDevices[existingIndex] = deviceData;
        } else {
          savedDevices.push(deviceData);
        }
        
        localStorage.setItem('smartwatchDevices', JSON.stringify(savedDevices));
        this.loadSavedDevices();
      }

      loadSavedDevices() {
        const savedDevices = JSON.parse(localStorage.getItem('smartwatchDevices') || '[]');
        const container = document.getElementById('savedDevices');
        
        if (savedDevices.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üì±</div>
              <p>Nessun dispositivo salvato</p>
              <small>Scansiona per trovare dispositivi compatibili</small>
            </div>
          `;
          return;
        }
        
        container.innerHTML = savedDevices.map(device => `
          <div class="device-item">
            <div class="device-info">
              <div class="device-name">
                <span class="status-indicator ${this.connectedDevices.has(device.id) ? 'status-connected' : 'status-disconnected'}"></span>
                ${device.name}
              </div>
              <div class="device-id">${device.id}</div>
              <small style="color: var(--text-muted);">Ultimo collegamento: ${new Date(device.lastConnected).toLocaleString()}</small>
            </div>
            <div class="device-actions">
              <button class="btn btn-success btn-small" onclick="smartWatch.reconnectDevice('${device.id}')">
                üîÑ Riconnetti
              </button>
              <button class="btn btn-danger btn-small" onclick="smartWatch.removeDevice('${device.id}')">
                üóëÔ∏è Rimuovi
              </button>
            </div>
          </div>
        `).join('');
      }

      updateDevicesList() {
        this.loadSavedDevices();
      }

      async reconnectDevice(deviceId) {
        try {
          const devices = await navigator.bluetooth.getDevices();
          const device = devices.find(d => d.id === deviceId);
          
          if (device) {
            await this.connectToDevice(device);
            this.showToast(`üîÑ Riconnesso a ${device.name || 'dispositivo'}`, "success");
          } else {
            this.showToast("‚ùå Dispositivo non trovato. Prova a scansionare di nuovo.", "error");
          }
        } catch (error) {
          this.showToast(`‚ùå Errore riconnessione: ${error.message}`, "error");
        }
      }

      removeDevice(deviceId) {
        const savedDevices = JSON.parse(localStorage.getItem('smartwatchDevices') || '[]');
        const filteredDevices = savedDevices.filter(d => d.id !== deviceId);
        localStorage.setItem('smartwatchDevices', JSON.stringify(filteredDevices));
        
        // Disconnetti se connesso
        if (this.connectedDevices.has(deviceId)) {
          const deviceInfo = this.connectedDevices.get(deviceId);
          if (deviceInfo.server && deviceInfo.server.connected) {
            deviceInfo.server.disconnect();
          }
          this.connectedDevices.delete(deviceId);
        }
        
        this.loadSavedDevices();
        this.showToast("üóëÔ∏è Dispositivo rimosso", "info");
      }

      async testConnection() {
        const testButton = event.target;
        this.setButtonLoading(testButton, true);
        
        try {
          // Test delle API Bluetooth
          if (!navigator.bluetooth) {
            throw new Error("Web Bluetooth non supportato");
          }
          
          const availability = await navigator.bluetooth.getAvailability();
          if (!availability) {
            throw new Error("Bluetooth non disponibile");
          }
          
          // Test connessioni esistenti
          let connectedCount = 0;
          for (const [id, device] of this.connectedDevices) {
            if (device.server && device.server.connected) {
              connectedCount++;
            }
          }
          
          this.showToast(`‚úÖ Test completato: ${connectedCount} dispositivi connessi`, "success");
          
        } catch (error) {
          this.showToast(`‚ùå Test fallito: ${error.message}`, "error");
        } finally {
          this.setButtonLoading(testButton, false);
        }
      }

      disconnectAll() {
        this.connectedDevices.forEach((deviceInfo, id) => {
          try {
            if (deviceInfo.server && deviceInfo.server.connected) {
              deviceInfo.server.disconnect();
            }
          } catch (err) {
            console.warn(`Errore disconnessione ${deviceInfo.name}:`, err);
          }
        });
        this.connectedDevices.clear();
        this.updateDevicesList();
        this.showToast("üîå Tutti i dispositivi disconnessi", "info");
      }
    }

    // Gestione tema
    function toggleTheme() {
      const html = document.documentElement;
      const themeIcon = document.getElementById('theme-icon');
      const currentTheme = html.getAttribute('data-theme');
      
      if (currentTheme === 'dark') {
        html.removeAttribute('data-theme');
        themeIcon.textContent = 'üåô';
        localStorage.setItem('theme', 'light');
      } else {
        html.setAttribute('data-theme', 'dark');
        themeIcon.textContent = '‚òÄÔ∏è';
        localStorage.setItem('theme', 'dark');
      }
    }

    // Carica tema salvato
    function loadTheme() {
      const savedTheme = localStorage.getItem('theme');
      const themeIcon = document.getElementById('theme-icon');
      
      if (savedTheme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        themeIcon.textContent = '‚òÄÔ∏è';
      } else {
        themeIcon.textContent = 'üåô';
      }
    }

    // Inizializza l'applicazione
    const smartWatch = new ImprovedSmartWatch();

    // Carica tema all'avvio
    loadTheme();

    // Espone le funzioni globali
    function checkCompatibility() {
      smartWatch.checkCompatibility();
    }

    function scanNewDevice() {
      smartWatch.scanNewDevice();
    }

    function testConnection() {
      smartWatch.testConnection();
    }

    // Animazioni di entrata ritardate
    setTimeout(() => {
      document.querySelectorAll('.slide-in').forEach((el, index) => {
        el.style.animationDelay = `${index * 0.2}s`;
      });
    }, 100);
  </script>
</body>
</html>